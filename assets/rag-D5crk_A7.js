import"./modulepreload-polyfill-B5Qt9EMX.js";const k="modulepreload",_=function(i){return"/wordy/"+i},v={},$=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let g=function(l){return Promise.all(l.map(u=>Promise.resolve(u).then(o=>({status:"fulfilled",value:o}),o=>({status:"rejected",reason:o}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),c=s?.nonce||s?.getAttribute("nonce");r=g(t.map(l=>{if(l=_(l),l in v)return;v[l]=!0;const u=l.endsWith(".css"),o=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${o}`))return;const m=document.createElement("link");if(m.rel=u?"stylesheet":k,u||(m.as="script"),m.crossOrigin="",m.href=l,c&&m.setAttribute("nonce",c),document.head.appendChild(m),u)return new Promise((y,f)=>{m.addEventListener("load",y),m.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(s){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=s,window.dispatchEvent(c),!c.defaultPrevented)throw s}return r.then(s=>{for(const c of s||[])c.status==="rejected"&&a(c.reason);return e().catch(a)})};class C{constructor(e={}){this.modelId=e.modelId||"onnx-community/embeddinggemma-300m-ONNX",this.dtype=e.dtype||"q8",this.pipeline=null,this.tokenizer=null,this.model=null,this.ready=!1,this.useEmbeddingGemma=this.modelId.includes("embeddinggemma")}async init(){try{console.log("üîÑ Loading embedding model:",this.modelId),console.log("   dtype:",this.dtype);const e=await $(()=>import("https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.7.2"),[]),{pipeline:t,env:n,AutoTokenizer:r,AutoModel:a}=e;return n.allowLocalModels=!1,n.allowRemoteModels=!0,n.useBrowserCache=!1,console.log("‚ö†Ô∏è Browser cache disabled - models will re-download each session"),console.log("   (IndexedDB may be blocked in iframe contexts)"),this.useEmbeddingGemma?(console.log("üîÑ Using EmbeddingGemma with AutoModel..."),this.tokenizer=await r.from_pretrained(this.modelId),this.model=await a.from_pretrained(this.modelId,{dtype:this.dtype,device:"wasm"}),console.log("‚úÖ EmbeddingGemma model loaded (768D embeddings)")):(console.log("üîÑ Using standard feature-extraction pipeline..."),this.pipeline=await t("feature-extraction",this.modelId),console.log("‚úÖ Embedding model loaded")),this.ready=!0,!0}catch(e){throw console.error("‚ùå Failed to load embedding model:",e),e}}async embed(e){if(!this.ready)throw new Error("Embedding model not initialized. Call init() first.");try{if(this.useEmbeddingGemma){const t=await this.tokenizer(e),r=(await this.model(t)).last_hidden_state,a=this.meanPooling(r,t.attention_mask),s=this.normalize(a);return new Float32Array(s.data)}else{const t=await this.pipeline(e,{pooling:"mean",normalize:!0});return new Float32Array(t.data)}}catch(t){throw console.error("‚ùå Embedding generation failed:",t),t}}meanPooling(e,t){const n=e.dims.map(o=>typeof o=="bigint"?Number(o):o),[r,a,s]=n,c=e.data,g=t.data,l=new Float32Array(s);for(let o=0;o<a;o++){const m=typeof g[o]=="bigint"?Number(g[o]):g[o];if(m>0)for(let y=0;y<s;y++){const f=o*s+y,w=typeof c[f]=="bigint"?Number(c[f]):c[f];l[y]+=w*m}}let u=0;for(let o=0;o<a;o++){const m=typeof g[o]=="bigint"?Number(g[o]):g[o];u+=m}u<1e-9&&(u=1e-9);for(let o=0;o<s;o++)l[o]/=u;return{data:l,dims:[1,s]}}normalize(e){const t=e.data;let n=0;for(let a=0;a<t.length;a++)n+=t[a]*t[a];n=Math.sqrt(n),n<1e-12&&(n=1e-12);const r=new Float32Array(t.length);for(let a=0;a<t.length;a++)r[a]=t[a]/n;return{data:r}}async embedBatch(e){if(!this.ready)throw new Error("Embedding model not initialized. Call init() first.");const t=[];for(const n of e){const r=await this.embed(n);t.push(r)}return t}isReady(){return this.ready}getInfo(){return{modelId:this.modelId,ready:this.ready,dimensions:768}}}class M{constructor(e={}){this.corpus=e.corpus||{words:[],embeddings:null},this.embeddingDim=e.embeddingDim||768,this.cache=new Map}loadCorpus(e){this.corpus=e,this.cache.clear(),console.log(`‚úÖ Loaded corpus: ${e.words.length} words`)}cosineSimilarity(e,t){let n=0,r=0,a=0;for(let s=0;s<e.length;s++)n+=e[s]*t[s],r+=e[s]*e[s],a+=t[s]*t[s];return n/(Math.sqrt(r)*Math.sqrt(a))}search(e,t=5,n={}){const{excludeQuery:r=!0,minSimilarity:a=0}=n;let s,c=null;if(typeof e=="string"){const o=this.corpus.words.indexOf(e);if(o===-1)return console.warn(`Word "${e}" not found in corpus`),[];c=e,s=this.corpus.embeddings.slice(o*this.embeddingDim,(o+1)*this.embeddingDim);const m=`${e}_${t}`;if(this.cache.has(m))return this.cache.get(m)}else s=e;const g=[],l=this.corpus.words.length;for(let o=0;o<l;o++){const m=this.corpus.words[o];if(r&&m===c)continue;const y=this.corpus.embeddings.slice(o*this.embeddingDim,(o+1)*this.embeddingDim),f=this.cosineSimilarity(s,y);f>=a&&g.push({word:m,similarity:f,index:o})}g.sort((o,m)=>m.similarity-o.similarity);const u=g.slice(0,t);if(c){const o=`${c}_${t}`;this.cache.set(o,u)}return u}batchSearch(e,t=5,n={}){return e.map(r=>this.search(r,t,n))}getEmbedding(e){const t=this.corpus.words.indexOf(e);return t===-1?null:this.corpus.embeddings.slice(t*this.embeddingDim,(t+1)*this.embeddingDim)}hasWord(e){return this.corpus.words.includes(e)}getStats(){return{totalWords:this.corpus.words.length,embeddingDim:this.embeddingDim,cacheSize:this.cache.size,memoryUsage:this.corpus.embeddings?this.corpus.embeddings.byteLength:0}}clearCache(){this.cache.clear(),console.log("‚úÖ Cache cleared")}}class P{constructor(e={}){this.modelId=e.modelId||"onnx-community/gemma-3-270m-it-ONNX",this.dtype=e.dtype||"q4",this.device=e.device||void 0,this.pipeline=null,this.ready=!1,this.maxTokens=e.maxTokens||256}async init(){try{const e="gpu"in navigator;!this.device&&e&&(console.log("üéÆ WebGPU detected, will try to use it for 2-3x faster generation"),this.device="webgpu"),console.log("üîÑ Loading generation model:",this.modelId),console.log("   Device:",this.device||"auto-detect (WASM fallback)"),console.log("   Quantization:",this.dtype);const{pipeline:t,env:n}=await $(async()=>{const{pipeline:a,env:s}=await import("https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.7.2");return{pipeline:a,env:s}},[]);n.allowLocalModels=!1,n.allowRemoteModels=!0,n.useBrowserCache=!1,console.log("‚ö†Ô∏è Browser cache disabled - models will re-download each session"),console.log("   (IndexedDB may be blocked in iframe contexts)");const r={dtype:this.dtype};return this.device&&(r.device=this.device),this.pipeline=await t("text-generation",this.modelId,r),this.ready=!0,console.log("‚úÖ Generation model loaded successfully"),console.log(`   Using: ${this.device||"WASM"} backend`),!0}catch(e){throw console.error("‚ùå Failed to load generation model:",e),console.warn("üí° Available quantizations: fp32 (large), fp16 (medium), q4 (small), q4f16"),console.warn("üí° Current dtype:",this.dtype),e}}async generate(e,t={}){if(!this.ready)throw new Error("Generation model not initialized. Call init() first.");try{const{maxNewTokens:n=this.maxTokens,temperature:r=.7,topK:a=50,topP:s=.9,doSample:c=!0,repetitionPenalty:g=1.1}=t;let l;return Array.isArray(e)?l=this.formatChatPrompt(e):l=e,(await this.pipeline(l,{max_new_tokens:n,temperature:r,top_k:a,top_p:s,do_sample:c,repetition_penalty:g,return_full_text:!1}))[0].generated_text}catch(n){throw console.error("‚ùå Text generation failed:",n),n}}formatChatPrompt(e){let t="";for(const n of e)n.role==="user"?t+=`<start_of_turn>user
${n.content}<end_of_turn>
`:n.role==="assistant"?t+=`<start_of_turn>model
${n.content}<end_of_turn>
`:n.role==="system"&&(t=`<start_of_turn>system
${n.content}<end_of_turn>
`+t);return t+=`<start_of_turn>model
`,t}async generateWithContext(e,t,n=null){if(!this.ready)throw new Error("Generation model not initialized. Call init() first.");const r=t.map((s,c)=>`${c+1}. ${s.word} (${(s.similarity*100).toFixed(1)}% similar)`).join(`
`),a=[];return n&&a.push({role:"system",content:n}),a.push({role:"user",content:`Context (similar words):
${r}

Query: ${e}`}),await this.generate(a)}isReady(){return this.ready}getInfo(){return{modelId:this.modelId,dtype:this.dtype,device:this.device,ready:this.ready,maxTokens:this.maxTokens}}async*streamGenerate(e,t={}){yield await this.generate(e,t)}}const h={embeddingModule:null,retrievalModule:null,generationModule:null,corpus:null,ready:!1};function d(i,e="info"){const t=document.getElementById("log-panel"),n=new Date().toLocaleTimeString(),r=document.createElement("div");r.className="log-entry";const a=`<span class="log-time">[${n}]</span>`,s=`<span class="log-${e}">${i}</span>`;r.innerHTML=`${a} ${s}`,t.appendChild(r),t.scrollTop=t.scrollHeight,console.log(`[${n}] ${i}`)}function p(i,e,t){const n=document.getElementById(i);n.textContent=e,n.className=`status-value status-${t}`}async function B(){try{d("üöÄ Starting RAG pipeline initialization...","info"),p("corpus-status","Loading...","loading");let i=null;if(d(`üîç Checking parent window... parent exists: ${!!window.parent}`,"info"),d(`üîç Checking corpusPreloader... exists: ${!!window.parent.corpusPreloader}`,"info"),window.parent&&window.parent.corpusPreloader){d("üîç Checking for cached corpus...","info");try{i=await window.parent.corpusPreloader.getCorpus(),d(`üì¶ Corpus returned: ${i?"YES":"NO"}`,"info"),i&&d(`üì¶ Corpus has ${i.words?.length||0} words`,"info")}catch(r){d(`‚ùå Error accessing corpus: ${r.message}`,"error")}}const e=12e4,t=3e3;let n=0;for(;!i&&n<e;){if(n===0?(d("‚è≥ Waiting for corpus download to complete...","info"),d("üí° Background preloader is downloading 455MB of data. This may take 30-60 seconds.","info")):d(`‚è≥ Still waiting... (${Math.floor(n/1e3)}s elapsed)`,"info"),await new Promise(r=>setTimeout(r,t)),window.parent&&window.parent.corpusPreloader)try{if(i=await window.parent.corpusPreloader.getCorpus(),i&&i.words&&i.embeddings){d(`‚úÖ Corpus ready after ${Math.floor(n/1e3)}s!`,"success");break}}catch(r){d(`‚ö†Ô∏è Polling error: ${r.message}`,"warning")}n+=t}if(i&&i.words&&i.embeddings)d("‚úÖ Using cached corpus from background download!","success"),h.corpus=i;else throw d("‚ùå Corpus download timeout after 2 minutes","error"),new Error("Corpus download timeout. Please reload the page and try again. Check your network connection.");p("corpus-status",`‚úÖ ${h.corpus.words.length.toLocaleString()} words loaded`,"ready"),d(`‚úÖ Loaded ${h.corpus.words.length.toLocaleString()} words with 768D embeddings`,"success"),p("retrieval-status","Initializing...","loading"),d("üîç Initializing retrieval module...","info"),h.retrievalModule=new M({corpus:h.corpus,embeddingDim:768}),p("retrieval-status","‚úÖ Ready","ready"),d("‚úÖ Retrieval module ready","success"),p("embedding-status","Loading model...","loading"),d("üîÑ Loading embedding model (paraphrase-albert-small-v2)...","info"),h.embeddingModule=new C,await h.embeddingModule.init(),p("embedding-status","‚úÖ Ready","ready"),d("‚úÖ Embedding model loaded","success"),p("generation-status","Loading model (this may take a while)...","loading"),d("üîÑ Loading Gemma 3 270M model (q4 quantized)...","info"),d("‚è≥ First load may take 1-2 minutes to download ~70MB model...","info"),h.generationModule=new P({modelId:"onnx-community/gemma-3-270m-it-ONNX",maxTokens:128}),await h.generationModule.init(),p("generation-status","‚úÖ Ready","ready"),d("‚úÖ Gemma 3 270M model loaded","success"),h.ready=!0,document.getElementById("query-input").disabled=!1,document.getElementById("generate-btn").disabled=!1,d("üéâ RAG pipeline fully initialized and ready!","success")}catch(i){d(`‚ùå Initialization failed: ${i.message}`,"error"),console.error("Initialization error:",i),p("embedding-status","‚ùå Error","error"),p("corpus-status","‚ùå Error","error"),p("retrieval-status","‚ùå Error","error"),p("generation-status","‚ùå Error","error")}}async function x(i){if(!h.ready){d("‚ö†Ô∏è System not ready yet","error");return}try{d(`
üîç Processing query: "${i}"`,"info");const e=document.getElementById("results-panel"),t=document.getElementById("metrics-panel"),n=document.getElementById("generated-text"),r=document.getElementById("retrieved-words");e.style.display="block",t.style.display="none",n.innerHTML='<div class="loading-spinner"></div> Generating answer...',r.innerHTML="",d("üìä Generating query embedding...","info");const a=performance.now(),s=await h.embeddingModule.embed(i),c=performance.now()-a;d(`‚úÖ Embedding generated in ${c.toFixed(1)}ms`,"success"),d("üîé Retrieving similar words from corpus...","info");const g=performance.now(),l=h.retrievalModule.search(s,5),u=performance.now()-g;d(`‚úÖ Retrieved ${l.length} words in ${u.toFixed(1)}ms`,"success"),l.forEach((b,I)=>{const E=document.createElement("div");E.className="word-chip",E.innerHTML=`
                        <span>${b.word}</span>
                        <span class="similarity-badge">${(b.similarity*100).toFixed(1)}%</span>
                    `,r.appendChild(E),d(`  ${I+1}. ${b.word} (${(b.similarity*100).toFixed(1)}% similar)`,"info")}),d("ü§ñ Generating answer with Gemma 3...","info");const o=performance.now(),y=await h.generationModule.generateWithContext(i,l,"You are a helpful assistant that explains words and concepts. Use the provided context words to give a clear, concise explanation."),f=performance.now()-o,w=performance.now()-a;d(`‚úÖ Answer generated in ${f.toFixed(1)}ms`,"success"),d(`‚è±Ô∏è Total pipeline time: ${w.toFixed(1)}ms`,"success"),n.textContent=y,document.getElementById("retrieval-time").textContent=u.toFixed(0),document.getElementById("generation-time").textContent=f.toFixed(0),document.getElementById("total-time").textContent=w.toFixed(0),document.getElementById("context-words").textContent=l.length,t.style.display="grid"}catch(e){d(`‚ùå RAG execution failed: ${e.message}`,"error"),console.error("RAG error:",e),document.getElementById("generated-text").textContent=`Error: ${e.message}

Please check the console for details.`}}document.getElementById("generate-btn").addEventListener("click",()=>{const i=document.getElementById("query-input").value.trim();i&&x(i)});document.getElementById("query-input").addEventListener("keydown",i=>{if(i.key==="Enter"){const e=i.target.value.trim();e&&x(e)}});document.querySelectorAll(".example-query").forEach(i=>{i.addEventListener("click",()=>{const e=i.getAttribute("data-query");document.getElementById("query-input").value=e,x(e)})});B();
//# sourceMappingURL=rag-D5crk_A7.js.map
